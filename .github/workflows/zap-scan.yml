name: "OWASP ZAP Scan (final stdout version)"

on:
  workflow_dispatch:

jobs:
  zap_scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        run: git clone https://github.com/${{ github.repository }} ./

      - name: Setup Node.js manually
        run: |
          sudo apt-get update -y
          sudo apt-get install -y nodejs npm curl

      - name: Install dependencies
        run: npm ci

      - name: Start app (dev mode)
        run: npm run dev &
        env:
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: "test"
          CLERK_SECRET_KEY: "test"

      - name: Wait until app is reachable
        run: |
          for i in {1..40}; do
            if curl -s http://localhost:3000 > /dev/null; then
              echo "✅ App is up!"
              break
            fi
            echo "Waiting... ($i)"
            sleep 5
          done

      # ⚡ Jalankan ZAP dan redirect seluruh hasilnya ke file lokal
      - name: Run ZAP baseline and capture output
        run: |
          echo "⚡ Running ZAP baseline scan..."
          docker run --rm --network="host" ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py -t http://localhost:3000 -a > zap_output.txt 2>&1 || true

      - name: Verify output file
        run: |
          echo "=== Check output ==="
          ls -lah
          echo "=== Preview ==="
          head -n 40 zap_output.txt || true

      - name: Upload ZAP output artifact
        uses: actions/upload-artifact@v4
        with:
          name: zap-output
          path: zap_output.txt
